# -*- coding: utf-8 -*-
"""Customer Churn Prediction (Logistic Regression).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vi7pd9eZbakuzYBb-UD5CKP-mXdNHVbA
"""

import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
# % matplotlib inline

df = pd.read_csv("/content/WA_Fn-UseC_-Telco-Customer-Churn.csv")

df

#Dropping customer ID since its not useful in Model Training
df=df.drop(columns='customerID')

df

df.info()

df.isnull().sum()

# Find rows with null TotalCharges-----there is no null in any of the coloumns so we can continue
null_totalcharges = df[df['TotalCharges'].isnull()]
null_totalcharges

#To check any cols has duplicates
df.duplicated()
duplicate = df[df['TotalCharges'].isnull()]
duplicate

df

df["TotalCharges"] = pd.to_numeric(df["TotalCharges"], errors="coerce")
df.info()
df["TotalCharges"].fillna(df["TotalCharges"].median(), inplace=True)

categorical_cols = df.select_dtypes(include='object').columns
categorical_cols

plt.figure(figsize=(16,16))
for i, col in enumerate(categorical_cols, 1):
    plt.subplot(3,3,i)
    sns.countplot(data=df, x=col)
    plt.title(col)
    plt.xticks(rotation=45)
    plt.tight_layout()
plt.show()

num_cols = df.select_dtypes(include=np.number).columns

plt.figure(figsize=(12,10))
for i, col in enumerate(num_cols, 1):
    plt.subplot(3,3,i)
    sns.histplot(df[col], kde=True)
    plt.title(col)
plt.tight_layout()
plt.show()

plt.figure(figsize=(15,15))
for i, col in enumerate(categorical_cols, 1):
    plt.subplot(3,2,i)
    sns.countplot(data=df, x=col, hue="Churn")
    plt.title(f"{col} vs Churn")
    plt.xticks(rotation=45)
    plt.tight_layout()
plt.show()

plt.figure(figsize=(12,10))
for i, col in enumerate(num_cols, 1):
    plt.subplot(3,3,i)
    sns.boxplot(x=df["Churn"], y=df[col])
    plt.title(f"{col} vs Churn")
plt.tight_layout()
plt.show()

plt.figure(figsize=(12,8))
sns.boxplot(data=df[num_cols])
plt.xticks(rotation=90)
plt.title("Outlier Detection")
plt.show()

# Quick Important Insights (Telco Churn)

# Customers with month-to-month contracts churn more
# Fiber optic internet users churn more
# Customers with no online security/backup/tech support churn more
# Senior citizens churn more
# Higher MonthlyCharges → higher churn
# Longer tenure → lower churn (loyal customers stay)

df

df["Churn"] = df["Churn"].map({"Yes": 1, "No": 0})
# Convert Churn to numeric (Yes=1, No=0)

from sklearn.preprocessing import LabelEncoder

df_encoded = df.copy()
le_dict = {}

for col in categorical_cols:
    le = LabelEncoder()
    df_encoded[col] = le.fit_transform(df[col])
    le_dict[col] = le

print("\nEncoded dataset shape:", df_encoded.shape)
print("\nFirst few rows after encoding:")
print(df_encoded.head())

X = df_encoded.drop("Churn", axis=1)
y = df_encoded["Churn"]

from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test = train_test_split( X, y, test_size=0.2, random_state=42, stratify=y)

from sklearn.preprocessing import StandardScaler

scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

from sklearn.linear_model import LogisticRegression
Logistic = LogisticRegression()
Logistic.fit(X_train_scaled,y_train)
y_pred = Logistic.predict(X_test_scaled)

from sklearn.metrics import accuracy_score,classification_report,confusion_matrix

score=accuracy_score(y_pred,y_test)
print(score)
print(classification_report(y_pred,y_test))
print(confusion_matrix(y_pred,y_test))

cm = confusion_matrix(y_pred,y_test)
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.title("Confusion Matrix")
plt.show()

from sklearn.metrics import roc_auc_score, roc_curve

y_prob = Logistic.predict_proba(X_test_scaled)[:,1]

auc = roc_auc_score(y_test, y_prob)
print("AUC Score:", auc)

fpr, tpr, th = roc_curve(y_test, y_prob)

plt.plot(fpr, tpr)
plt.plot([0,1],[0,1], 'k--')
plt.xlabel("False Positive Rate")
plt.ylabel("True Positive Rate")
plt.title("ROC Curve")
plt.show()

y_prob

prob_df = pd.DataFrame({
    "Actual_Churn": y_test.values,
    "Predicted_Class": y_pred,
    "Churn_Probability": y_prob
})

prob_df.head()

all_prob = Logistic.predict_proba(scaler.transform(X))[:, 1]
df["Churn_Probability"] = all_prob
df.head()

df["Risk"] = df["Churn_Probability"].apply(lambda x: "High" if x > 0.7 else "Low")
df

df.to_csv("telco_churn_probabilities_full.csv", index=False)
print("CSV file created successfully: telco_churn_probabilities_full.csv")